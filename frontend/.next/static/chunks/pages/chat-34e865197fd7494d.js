(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[180],{7722:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return a(6380)}])},6380:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return i}});var n=a(5893),r=a(7294);let s=(a(3454).env.NEXT_PUBLIC_API_URL||"http://localhost:4000").replace(/\/$/,"");function i(){var e;let[t,a]=(0,r.useState)(null),[i,c]=(0,r.useState)(""),[l,o]=(0,r.useState)([]),[d,u]=(0,r.useState)([]),[h,m]=(0,r.useState)(null),[v,f]=(0,r.useState)([]),[p,g]=(0,r.useState)(""),[x,y]=(0,r.useState)(!1),j=(0,r.useRef)(null),w=(0,r.useRef)(null),N=(0,r.useRef)(null),b=(0,r.useRef)(null);async function _(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{let t=await fetch("".concat(s,"/api/conversations"),{withCredentials:!0});if(u(t.data||[]),e&&t.data&&t.data.length){let e=t.data[0];await C({id:e.id,name:e.other_username||e.name||"#".concat(e.id)},!1)}}catch(e){console.error("loadConversations error",e)}}async function C(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],a=e.id;m({id:a,name:e.other_username||e.name||"#".concat(a)}),f([]);try{j.current&&j.current.emit("join",{conversationId:a})}catch(e){}try{let e=await fetch("".concat(s,"/api/messages/").concat(a),{withCredentials:!0});f(e.data||[]),setTimeout(()=>{w.current&&(w.current.scrollTop=w.current.scrollHeight)},40)}catch(e){console.error("fetch messages error",e)}t&&_().catch(()=>{})}async function S(e){try{let t=await axios.post("".concat(s,"/api/conversations"),{otherUserId:e.id},{withCredentials:!0}),a=t.data.id;await C({id:a,other_username:t.data.other_username||e.username}),c(""),o([]),_().catch(()=>{})}catch(e){console.error("open conv error",e)}}async function k(e,a){if(!e||!a||!t)return;let n={conversationId:e,senderId:t.id,content:a.trim()};try{g(""),j.current&&j.current.emit("message",n)}catch(e){console.error(e)}}async function T(e){e&&e.preventDefault&&e.preventDefault(),p.trim()&&h&&await k(h.id,p)}return(0,r.useRef)(null),(0,r.useEffect)(()=>{let e=!0;return async function(){try{let t=await fetch("".concat(s,"/api/auth/me"),{withCredentials:!0});if(!e)return;a(t.data.user),j.current=io(s,{withCredentials:!0}),j.current.on("connect",async()=>{try{var e;let t=await fetch("".concat(s,"/api/auth/token"),{withCredentials:!0});(null===(e=t.data)||void 0===e?void 0:e.token)&&j.current.emit("auth",{token:t.data.token})}catch(e){}}),j.current.off("message"),j.current.on("message",e=>{var t,a;let n=null!==(a=null!==(t=e.conversation_id)&&void 0!==t?t:e.conversationId)&&void 0!==a?a:null;n&&N.current&&n===N.current?(f(t=>t.some(t=>String(t.id)===String(e.id))?t:[...t,e]),setTimeout(()=>{w.current&&(w.current.scrollTop=w.current.scrollHeight)},40)):_().catch(()=>{})}),await _(!0)}catch(e){console.error("init error",e),window.location.href="/login"}}(),()=>{e=!1,j.current&&j.current.disconnect()}},[]),(0,r.useEffect)(()=>{var e;N.current=null!==(e=null==h?void 0:h.id)&&void 0!==e?e:null,h&&window.innerWidth<=860&&y(!1)},[h]),(0,r.useEffect)(()=>{let e=setTimeout(()=>{if(!i.trim())return o([]);(async()=>{try{let e=await fetch("".concat(s,"/api/users/search"),{params:{query:i},withCredentials:!0});o((e.data||[]).filter(e=>e.id!==(null==t?void 0:t.id)))}catch(e){console.error("search error",e)}})()},220);return()=>clearTimeout(e)},[i,t]),(0,n.jsxs)("div",{className:"app-root",children:[(0,n.jsx)("aside",{className:"sidebar ".concat(x?"open":""),children:(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"brand",children:"Chat"}),t&&(0,n.jsxs)("div",{className:"logged-as",children:["Logged in as ",(0,n.jsx)("b",{children:t.username})]})]}),(0,n.jsx)("div",{style:{display:"flex",gap:8},children:window.innerWidth<=860&&(0,n.jsx)("button",{onClick:()=>y(!1),children:"Close"})})]}),(0,n.jsx)("input",{className:"search-bar",ref:b,value:i,onChange:e=>c(e.target.value),placeholder:"Search username..."}),(0,n.jsxs)("div",{className:"scroll",style:{display:"flex",flexDirection:"column",gap:8},children:[l.map(e=>(0,n.jsxs)("div",{className:"conv-item",onClick:()=>S(e),children:[(0,n.jsx)("div",{className:"avatar",children:e.username.charAt(0).toUpperCase()}),(0,n.jsx)("div",{style:{flex:1},children:e.username})]},e.id)),(0,n.jsx)("div",{style:{marginTop:8},children:d.map(e=>(0,n.jsxs)("div",{className:"conv-item ".concat((null==h?void 0:h.id)===e.id?"active":""),onClick:()=>C({id:e.id,other_username:e.other_username}),children:[(0,n.jsx)("div",{className:"avatar",children:(e.other_username||e.name||"#".concat(e.id)).charAt(0).toUpperCase()}),(0,n.jsxs)("div",{style:{flex:1},children:[(0,n.jsx)("div",{style:{fontWeight:600},children:e.other_username||e.name||"#".concat(e.id)}),(0,n.jsx)("div",{style:{color:"var(--muted)",fontSize:13},children:e.last_message||(0,n.jsx)("span",{className:"muted",children:"No messages"})})]})]},e.id))})]})]})}),(0,n.jsxs)("main",{className:"main",children:[(0,n.jsxs)("div",{className:"chat-header",children:[(0,n.jsx)("button",{className:"header-hamburger",onClick:function(){y(e=>!e)},"aria-label":"Toggle sidebar",style:{display:"inline-block",marginRight:6},children:"â˜°"}),(0,n.jsx)("div",{style:{fontWeight:700},children:h?h.name:"Select someone to start chatting"}),(0,n.jsxs)("div",{className:"logged-user",style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:8},children:[(null==t?void 0:t.avatar)?(0,n.jsx)("img",{src:t.avatar.startsWith("/")?"".concat(s).concat(t.avatar):"".concat(s,"/").concat(t.avatar),alt:"pfp",style:{width:36,height:36,borderRadius:999,objectFit:"cover"}}):(0,n.jsx)("div",{style:{width:36,height:36,borderRadius:999,background:"#ddd",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700},children:null==t?void 0:null===(e=t.username)||void 0===e?void 0:e.charAt(0).toUpperCase()}),(0,n.jsx)("div",{style:{fontSize:13,color:"var(--muted)"},children:null==t?void 0:t.username})]})]}),(0,n.jsx)("div",{className:"messages",ref:w,children:v.map(e=>{let a=e.sender_id===(null==t?void 0:t.id)||e.sender===(null==t?void 0:t.username),r=e.sender||(a?null==t?void 0:t.username:"User");return(0,n.jsxs)("div",{className:"msg-row ".concat(a?"mine":""),children:[(0,n.jsx)("div",{className:"msg-avatar",children:r.charAt(0).toUpperCase()}),(0,n.jsxs)("div",{className:"msg-body",children:[(0,n.jsx)("div",{className:"msg-author",children:r}),(0,n.jsx)("div",{className:"msg-bubble",children:e.content})]})]},e.id)})}),(0,n.jsxs)("form",{className:"composer",onSubmit:e=>{e.preventDefault(),T(e)},children:[(0,n.jsx)("input",{value:p,onChange:e=>g(e.target.value),placeholder:h?"Type a message...":"Select a user to chat",disabled:!h}),(0,n.jsx)("button",{type:"submit",disabled:!h||!p.trim(),children:"Send"})]})]})]})}}},function(e){e.O(0,[888,774,179],function(){return e(e.s=7722)}),_N_E=e.O()}]);